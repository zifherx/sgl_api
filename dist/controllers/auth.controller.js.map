{"version":3,"sources":["../../src/controllers/auth.controller.js"],"names":["authCtrl","iniciarSesion","req","res","body","username","password","User","findOne","userFound","status","json","message","online","matchPassword","token","jwt","sign","id","_id","index","SECRET","expiresIn","findByIdAndUpdate","console","log","userCod","cambiarContrasena","locals","jwtPayload","oldPassword","newPassword","findById","encryptPassword","save","newObj","error","cerrarSesion","offline","forzarCierreSesion","idUser"],"mappings":"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","sourcesContent":["import jwt from 'jsonwebtoken'\r\nimport index from '../config'\r\nimport User from '../models/User'\r\n\r\nconst authCtrl = {}\r\n\r\nauthCtrl.iniciarSesion = async(req, res) => {\r\n    const { username, password } = req.body\r\n\r\n    const userFound = await User.findOne({ username })\r\n\r\n    if (!userFound) return res.status(404).json({ message: 'Usuario no existe' });\r\n\r\n    if (!userFound.status) return res.status(403).json({ message: 'Usuario Inactivo' });\r\n\r\n    if (userFound.online) return res.status(401).json({ message: 'Usuario ya se encuentra logueado' });\r\n\r\n    const matchPassword = await User.matchPassword(password, userFound.password);\r\n\r\n    if (!matchPassword) return res.status(403).json({ token: null, message: 'Contraseña Errónea' });\r\n\r\n    const token = jwt.sign({ id: userFound._id }, index.SECRET, { expiresIn: '48h' });\r\n\r\n    //Cambio de estado a online\r\n    const online = await User.findByIdAndUpdate(userFound._id, { online: true });\r\n    console.log('Token:', token);\r\n\r\n    res.json({ token, userCod: userFound._id })\r\n}\r\n\r\nauthCtrl.cambiarContrasena = async(req, res) => {\r\n    const { id } = res.locals.jwtPayload;\r\n    const { oldPassword, newPassword } = req.body;\r\n\r\n    if (!(oldPassword && newPassword)) return res.status(409).json({ message: 'Contraseñas no coinciden' })\r\n\r\n    const userFound = await User.findById(id);\r\n\r\n    if (!userFound) return res.status(404).json({ message: 'Usuario no existe' })\r\n\r\n    const matchPassword = await User.matchPassword(oldPassword, userFound.password);\r\n    if (!matchPassword) return res.status(401).json({ token: null, message: 'Contraseña Errónea' })\r\n\r\n    try {\r\n        userFound.password = await User.encryptPassword(newPassword);\r\n        const newObj = await userFound.save();\r\n        if (newObj) res.json({ message: 'Contraseña actualizada con éxito' })\r\n    } catch (err) {\r\n        console.log(err)\r\n        return res.status(503).json({ error: err.message })\r\n    }\r\n}\r\n\r\nauthCtrl.cerrarSesion = async(req, res) => {\r\n    const { id } = res.locals.jwtPayload;\r\n\r\n    try {\r\n        const userFound = await User.findById(id);\r\n        if (!userFound.online) return res.status(401).json({ message: 'No existe sesión abierta' })\r\n        const offline = await User.findByIdAndUpdate(id, { online: false })\r\n        if (offline) return res.json({ message: 'Sesión cerrada con éxito' })\r\n    } catch (err) {\r\n        return res.status(503).json({ error: err });\r\n    }\r\n}\r\n\r\nauthCtrl.forzarCierreSesion = async(req, res) => {\r\n    const { username } = req.body\r\n\r\n    try {\r\n        const userFound = await User.findOne({ username });\r\n        let idUser = userFound._id;\r\n        if (!userFound) return res.status(404).json({ message: 'Usuario no existe' })\r\n        if (!userFound.online) return res.status(400).json({ message: 'No existe sesión iniciada' })\r\n        const offline = await User.findByIdAndUpdate(idUser, { online: false });\r\n        if (offline) return res.json({ message: 'Se forzó el cierre de sesión' })\r\n    } catch (err) {\r\n        console.log(err);\r\n        return res.status(503).json({ error: err });\r\n    }\r\n}\r\n\r\nexport default authCtrl"],"file":"auth.controller.js"}