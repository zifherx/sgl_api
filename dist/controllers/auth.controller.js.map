{"version":3,"sources":["../../src/controllers/auth.controller.js"],"names":["authCtrl","iniciarSesion","req","res","body","username","password","User","findOne","userFound","status","json","message","online","matchPassword","token","jwt","sign","id","_id","index","SECRET","expiresIn","findByIdAndUpdate","console","log","codigoUser","cambiarContrasena","locals","jwtPayload","oldPassword","newPassword","findById","encryptPassword","save","newObj","cerrarSesion","offline","forzarCierreSesion","idUser"],"mappings":"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","sourcesContent":["import jwt from 'jsonwebtoken'\r\nimport index from '../config'\r\nimport User from '../models/User'\r\n\r\nconst authCtrl = {}\r\n\r\nauthCtrl.iniciarSesion = async(req, res) => {\r\n    const { username, password } = req.body\r\n\r\n    const userFound = await User.findOne({ username })\r\n\r\n    if (!userFound) return res.status(404).json({ message: 'Usuario no existe' })\r\n\r\n    if (!userFound.status) return res.status(403).json({ message: 'Usuario Inactivo' })\r\n\r\n    if (userFound.online === 1) return res.status(401).json({ message: 'Usuario ya se encuentra logueado' })\r\n\r\n    const matchPassword = await User.matchPassword(password, userFound.password)\r\n\r\n    if (!matchPassword) return res.status(403).json({ token: null, message: 'Contraseña Errónea' })\r\n\r\n    const token = jwt.sign({ id: userFound._id }, index.SECRET, { expiresIn: '24h' })\r\n\r\n    //Cambio de estado a online\r\n    const online = await User.findByIdAndUpdate(userFound._id, { online: 1 })\r\n    console.log('Token:', token)\r\n\r\n    res.json({ token, codigoUser: userFound._id })\r\n}\r\n\r\nauthCtrl.cambiarContrasena = async(req, res) => {\r\n    const { id } = res.locals.jwtPayload;\r\n    const { oldPassword, newPassword } = req.body;\r\n\r\n    if (!(oldPassword && newPassword)) return res.status(409).json({ message: 'Contraseñas no coinciden' })\r\n\r\n    const userFound = await User.findById(id);\r\n\r\n    if (!userFound) return res.status(404).json({ message: 'Usuario no existe' })\r\n\r\n    const matchPassword = await User.matchPassword(oldPassword, userFound.password);\r\n    if (!matchPassword) return res.status(409).json({ token: null, message: 'Contraseña Errónea' })\r\n\r\n    userFound.password = await User.encryptPassword(newPassword);\r\n    const newObj = await userFound.save();\r\n    try {\r\n        if (newObj) return res.json({ message: 'Contraseña actualizada con éxito' })\r\n    } catch (err) {\r\n        console.log(err)\r\n        return res.status(503).json({ message: err.message })\r\n    }\r\n}\r\n\r\nauthCtrl.cerrarSesion = async(req, res) => {\r\n    const { id } = res.locals.jwtPayload\r\n\r\n    try {\r\n\r\n        const userFound = await User.findById(id)\r\n\r\n        if (userFound.online === 0) return res.status(401).json({ message: 'No existe sesión abierta' })\r\n\r\n        const offline = await User.findByIdAndUpdate(id, { online: 0 })\r\n\r\n        if (offline) return res.json({ message: 'Sesión cerrada con éxito' })\r\n    } catch (err) {\r\n        return res.status(503).json({ message: err.message })\r\n    }\r\n}\r\n\r\nauthCtrl.forzarCierreSesion = async(req, res) => {\r\n    const { username } = req.body\r\n\r\n    try {\r\n        const userFound = await User.findOne({ username })\r\n            // console.log(userFound)\r\n        const idUser = userFound._id\r\n        console.log(idUser)\r\n\r\n        if (!userFound) return res.status(404).json({ message: 'Usuario no existe' })\r\n\r\n        if (userFound.online === 0) return res.status(401).json({ message: 'No existe sesión iniciada' })\r\n\r\n        const offline = await User.findByIdAndUpdate(idUser, { online: 0 })\r\n\r\n        // console.log(offline)\r\n\r\n        if (offline) return res.json({ message: 'Se forzó el cierre de sesión' })\r\n\r\n    } catch (err) {\r\n        return res.status(503).json({ message: err.message })\r\n    }\r\n\r\n}\r\n\r\nexport default authCtrl"],"file":"auth.controller.js"}